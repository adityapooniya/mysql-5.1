--source include/have_innodb_plugin.inc
--source include/have_innodb_32k.inc

let $file_format_check_save = `select @@innodb_file_format_check`;
let $disable_working_set_size_save = `select @@disable_working_set_size`;

--disable_warnings
drop table if exists t1;
drop table if exists t2;
--enable_warnings

set global DISABLE_WORKING_SET_SIZE = OFF;
set WORKING_DURATION = 300;
flush statistics;

create table t1 (i int primary key auto_increment) engine=innodb;

select working_set_size between 3 and 5
from information_schema.db_statistics
where db='test';

insert into t1 values (1);
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 3 and 6
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 5 and 8
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 7 and 9
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 9 and 13
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 15 and 19
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 25 and 31
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 47 and 159
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 90 and 112
from information_schema.db_statistics
where db='test';

insert into t1 select NULL from t1;
select count(*) from t1;
select working_set_size between 178 and 218
from information_schema.db_statistics
where db='test';

create table t2 (i int primary key auto_increment)
key_block_size=16 engine=innodb;

select working_set_size between 182 and 224
from information_schema.db_statistics
where db='test';

insert into t2 values (1);
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 184 and 226
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 185 and 227
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 188 and 230
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 191 and 235
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 198 and 242
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 215 and 263
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 249 and 305
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 314 and 384
from information_schema.db_statistics
where db='test';

insert into t2 select NULL from t2;
select count(*) from t2;
select working_set_size between 441 and 541
from information_schema.db_statistics
where db='test';

flush statistics;

select working_set_size from information_schema.db_statistics
where db='test';

drop table t1;
drop table t2;

# restore innodb_file_format and innodb_file_format_check
# Wish we did not have to waste time on this -- http://bugs.mysql.com/bug.php?id=62075
--disable_query_log
eval SET GLOBAL disable_working_set_size = $disable_working_set_size_save;
eval SET GLOBAL innodb_file_format_check = $file_format_check_save;
