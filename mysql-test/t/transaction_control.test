#
# test transaction_control for max_concurrent_transactions = 1
#
#
--source include/have_innodb_plugin.inc

grant all on *.* to 'adminc'@'%' with max_concurrent_transactions 1 max_user_connections 100;
select User, Host, max_user_connections, max_concurrent_transactions from mysql.user where User = 'adminc';

#
# First test a query.
#

connect (tc1, localhost, adminc,,);
show grants;
create table tctest(id int, primary key(id)) engine=innodb;
insert into tctest values (1), (2), (3);
select * from tctest /* 1 */;

connect (tc2, localhost, adminc,,);
send select id, sleep(id) from tctest;
sleep 0.1;

connection tc1;
send select * from tctest /* 2 */;
sleep 0.1;

connection default;
sleep 0.75;
--replace_column 1 # 6 #
show processlist;

connection tc2;
reap;
connection tc1;
reap;
begin /* 1 */;
insert into tctest values (4);

connection tc2;
send select * from tctest /* 3 */;

connection default;
sleep 0.75;
--replace_column 1 # 6 #
show processlist;

connection tc1;
commit;

connection tc2;
reap;

sleep 0.5;
--replace_column 1 # 6 #
show processlist;

connection tc1;
begin /* 2 */;
insert into tctest values (17);

connection tc2;
set wait_timeout=3;
--error ER_TRANSACTION_CONTROL_TIMEOUT
select * from tctest /* 4 */;

connection tc1;
commit;

connection default;
disconnect tc1;
disconnect tc2;
drop user 'adminc'@'%';
drop table tctest;

select User, Host, max_user_connections, max_concurrent_transactions from mysql.user where User = 'adminc';
